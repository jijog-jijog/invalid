
// ========================================
// ZENKIT VIEW TASKS FUNCTION
// Display tasks from a list in table format
// ========================================
// Get form input
listIdValue = "";
formValues = null;
isFormValid = form != null;
if(isFormValid)
{
	formValues = form.get("values");
}
if(formValues != null)
{
	listIdFromForm = formValues.get("listId");
	if(listIdFromForm != null)
	{
		listIdStr = listIdFromForm + "";
		try 
		{
			listIdValue = listIdFromForm.get("value") + "";
		}
		catch (e1)
		{
			if(listIdStr.contains("\"value\""))
			{
				startIdx = listIdStr.indexOf("\"value\"");
				if(startIdx >= 0)
				{
					afterValue = listIdStr.substring(startIdx + 7);
					numStart = afterValue.indexOf(":") + 1;
					numEnd = afterValue.indexOf("}",numStart);
					if(numEnd > numStart)
					{
						listIdValue = afterValue.substring(numStart,numEnd).trim();
						if(listIdValue.startsWith("\""))
						{
							if(listIdValue.endsWith("\""))
							{
								listIdValue = listIdValue.substring(1,listIdValue.length() - 1);
							}
						}
					}
				}
			}
			else
			{
				listIdValue = listIdStr;
			}
		}
	}
}
info "zenkit_view_tasks - listIdValue: " + listIdValue;
// Initialize response
response = Map();
response.put("text","Loading tasks...");
isListIdEmpty = listIdValue == null;
if(isListIdEmpty)
{
	isListIdEmpty = listIdValue == "";
}
if(isListIdEmpty)
{
	response.put("text","âŒ No list selected. Please select a project/list first.");
	return response;
}
// ========================================
// FETCH TASKS FROM LIST
// ========================================
info "Fetching tasks from list: " + listIdValue;
// Fetch list details for the name
listDetailsUrl = "https://base.zenkit.com/api/v1/lists/" + listIdValue;
listName = "your project";
try 
{
	listResponse = invokeurl
	[
		url :listDetailsUrl
		type :GET
		connection:"zenkitconnect"
	];
	if(listResponse != null)
	{
		fetchedName = listResponse.get("name");
		if(fetchedName != null)
		{
			listName = fetchedName + "";
		}
	}
}
catch (listError)
{
	info "Could not fetch list name: " + listError;
}
entriesSearchUrl = "https://base.zenkit.com/api/v1/lists/" + listIdValue + "/entries/search";
info "API URL: " + entriesSearchUrl;
tasksList = List();
try 
{
	entriesResponse = invokeurl
	[
		url :entriesSearchUrl
		type :GET
		connection:"zenkitconnect"
	];
	info "API Response received";
	isResponseNull = entriesResponse == null;
	if(isResponseNull == false)
	{
		// Try direct iteration first
		try 
		{
			item = null;
			for each  item in entriesResponse
			{
				tasksList.add(item);
			}
			info "Direct iteration found " + tasksList.size() + " tasks";
		}
		catch (iterError)
		{
			info "Direct iteration failed, trying as Map";
			// Try as Map with common keys
			try 
			{
				if(entriesResponse.containsKey("entries"))
				{
					tasksList = entriesResponse.get("entries");
					info "Found 'entries' key with " + tasksList.size() + " tasks";
				}
				else if(entriesResponse.containsKey("items"))
				{
					tasksList = entriesResponse.get("items");
					info "Found 'items' key with " + tasksList.size() + " tasks";
				}
				else if(entriesResponse.containsKey("data"))
				{
					tasksList = entriesResponse.get("data");
					info "Found 'data' key with " + tasksList.size() + " tasks";
				}
				else if(entriesResponse.containsKey("results"))
				{
					tasksList = entriesResponse.get("results");
					info "Found 'results' key with " + tasksList.size() + " tasks";
				}
			}
			catch (mapError)
			{
				info "Map extraction failed: " + mapError;
			}
		}
	}
}
catch (apiError)
{
	info "API Error: " + apiError;
	response.put("text","âŒ Error fetching tasks: " + apiError);
	return response;
}
// ========================================
// BUILD RESPONSE
// ========================================
totalTasks = tasksList.size();
info "Total tasks to display: " + totalTasks;
if(totalTasks == 0)
{
	// No tasks found - return message with create task button
	response = Map();
	response.put("text","No tasks currently assigned to the " + listName + " project. Click the button below to create a new task.");
	bot = Map();
	bot.put("name","No Active Tasks");
	response.put("bot",bot);
	buttonsList = List();
	buttonsList0 = Map();
	buttonsList0.put("label","âž• Add Task");
	buttonsList0.put("type","+");
	action = Map();
	action.put("type","invoke.function");
	data = Map();
	data.put("name","ZenkitcreatetaskForm");
	action.put("data",data);
	buttonsList0.put("action",action);
	buttonsList.add(buttonsList0);
	response.put("buttons",buttonsList);
	return response;
}
// Build slides with table
slidesList = List();
// ========================================
// TABLE SLIDE
// ========================================
tableSlide = Map();
tableSlide.put("type","table");
tableSlide.put("title","ðŸ“‹ Tasks in Project");
tableData = Map();
// Table headers
headersList = List();
headersList.add("Task Name");
headersList.add("Status");
headersList.add("Assigned To");
headersList.add("Due Date");
tableData.put("headers",headersList);
// Table rows
rowsList = List();
taskIndex = 0;
entry = null;
for each  entry in tasksList
{
	taskIndex = taskIndex + 1;
	info "Processing task " + taskIndex + ": " + entry;
	try 
	{
		// Extract task data
		taskName = entry.get("displayString");
		if(taskName == null)
		{
			taskName = entry.get("name");
		}
		if(taskName == null)
		{
			taskName = "Task " + taskIndex;
		}
		taskStatus = "Not Set";
		assignedTo = "-";
		dueDate = "-";
		// Find fields dynamically by looking for known suffixes in the entry
		// Each field key format: {uuid}_{fieldType}
		// Find status field - look for any key ending with _categories_sort (has display values)
		statusFieldKey = "";
		try 
		{
			entryStr = entry + "";
			// First try _categories_sort (display values)
			catSortIdx = entryStr.indexOf("_categories_sort");
			if(catSortIdx > 0)
			{
				searchStr = entryStr.substring(0,catSortIdx);
				lastQuoteIdx = searchStr.lastIndexOf("\"");
				if(lastQuoteIdx > 0)
				{
					statusFieldKey = searchStr.substring(lastQuoteIdx + 1);
					statusFieldKey = statusFieldKey + "_categories_sort";
					statusField = entry.get(statusFieldKey);
					if(statusField != null)
					{
						// statusField is an array of category objects
						try 
						{
							statusList = statusField;
							statusListSize = statusList.size();
							if(statusListSize > 0)
							{
								firstStatus = statusList.get(0);
								statusName = firstStatus.get("name");
								if(statusName != null)
								{
									taskStatus = statusName + "";
								}
							}
						}
						catch (parseError)
						{
							// If it's not a list, try converting to string
							statusStr = statusField + "";
							if(statusStr.length() > 0 && statusStr != "[]")
							{
								taskStatus = statusStr;
							}
						}
					}
				}
			}
		}
		catch (e)
		{
			info "Error extracting status: " + e;
		}
		// Find assignee field - look for any key ending with _persons_sort
		assigneeFieldKey = "";
		try 
		{
			entryStr = entry + "";
			personsSortIdx = entryStr.indexOf("_persons_sort");
			if(personsSortIdx > 0)
			{
				searchStr = entryStr.substring(0,personsSortIdx);
				lastQuoteIdx = searchStr.lastIndexOf("\"");
				if(lastQuoteIdx > 0)
				{
					assigneeFieldKey = searchStr.substring(lastQuoteIdx + 1);
					assigneeFieldKey = assigneeFieldKey + "_persons_sort";
					assigneeField = entry.get(assigneeFieldKey);
					if(assigneeField != null)
					{
						try 
						{
							personsList = assigneeField;
							personListSize = personsList.size();
							if(personListSize > 0)
							{
								firstPerson = personsList.get(0);
								personName = firstPerson.get("displayname");
								if(personName != null)
								{
									assignedTo = personName + "";
								}
							}
						}
						catch (listError)
						{
							assignedTo = assigneeField + "";
						}
					}
				}
			}
		}
		catch (e)
		{
			info "Error extracting assignee: " + e;
		}
		// Find due date field - look for any key ending with _date (but not _endDate)
		dueDateFieldKey = "";
		try 
		{
			entryStr = entry + "";
			dateIdx = entryStr.indexOf("_date\"");
			if(dateIdx > 0)
			{
				searchStr = entryStr.substring(0,dateIdx);
				lastQuoteIdx = searchStr.lastIndexOf("\"");
				if(lastQuoteIdx > 0)
				{
					potentialKey = searchStr.substring(lastQuoteIdx + 1);
					// Make sure it's not _endDate
					isEndDate = potentialKey.endsWith("_endDate");
					if(isEndDate == false)
					{
						dueDateFieldKey = potentialKey + "_date";
						dueDateField = entry.get(dueDateFieldKey);
						if(dueDateField != null)
						{
							dueDate = dueDateField + "";
						}
					}
				}
			}
		}
		catch (e)
		{
			info "Error extracting due date: " + e;
		}
		info "Found fields - Status: " + statusFieldKey + ", Assignee: " + assigneeFieldKey + ", DueDate: " + dueDateFieldKey;
		// Add row
		row = Map();
		row.put("Task Name",taskName);
		row.put("Status",taskStatus);
		row.put("Assigned To",assignedTo);
		row.put("Due Date",dueDate);
		rowsList.add(row);
	}
	catch (rowError)
	{
		info "Error processing task: " + rowError;
	}
}
tableData.put("rows",rowsList);
tableSlide.put("data",tableData);
slidesList.add(tableSlide);
response.put("slides",slidesList);
response.put("text","âœ… Tasks from " + listName + ":");
// Add "Add Task" button at the bottom of task list
buttonsList = List();
buttonsList0 = Map();
buttonsList0.put("label","âž• Add Task");
buttonsList0.put("type","+");
action = Map();
action.put("type","invoke.function");
data = Map();
data.put("name","ZenkitcreatetaskForm");
action.put("data",data);
buttonsList0.put("action",action);
buttonsList.add(buttonsList0);
response.put("buttons",buttonsList);
return response;
